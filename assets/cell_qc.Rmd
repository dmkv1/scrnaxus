---
title: "`r params$sample_id` - cell QC"
output:
  html_notebook:
    code_folding: hide
params:
  sample_id: "P009_DG"
  path_sce_input: "/media/data/NGS/Projects/MCL-scrnaseq-phanthomMenace/scrnaxus/results/P009_DG/doublets/P009_DG_singlets.sce"
  path_sce_output: "test_sce.rds"
  nUMI_thresh: 600
  nGenes_thresh: 300
  mitochondrial_thresh: 10
  seed: 42
---

```{r setup}
sample_id <- params$sample_id
path_sce_input <- params$path_sce_input
path_sce_output <- params$path_sce_output
nUMI_thresh <- as.numeric(params$nUMI_thresh)
nGenes_thresh <- as.numeric(params$nGenes_thresh)
mitochondrial_thresh <- as.numeric(params$mitochondrial_thresh)

seed <- params$seed
set.seed(seed)

# Load the libraries
suppressPackageStartupMessages({
  library(SingleCellExperiment)
  library(Seurat)
  library(scater)
  library(scran)
  library(stringr)
  library(dplyr)
  library(patchwork)
})

# QC plots function
QC_plots <- function(sce, color_groups, nUMI_thresh, nGenes_thresh, mitochondrial_thresh) {
  scater::plotColData(sce, y = "sum", color_by = color_groups) + scale_y_continuous(trans = "log10") +
    geom_hline(yintercept = nUMI_thresh, linetype = "dashed") +
    labs(y = "UMIs per cell, log10") +
    
    scater::plotColData(sce, y = "detected", color_by = color_groups) + scale_y_continuous(trans = "log10") +
    geom_hline(yintercept = nGenes_thresh, linetype = "dashed") +
    labs(y = "Genes per cell, log10") +
    
    scater::plotColData(sce, y = "subsets_Mito_percent", color_by = color_groups) + scale_y_continuous(limits = c(0, 100)) +
    geom_hline(yintercept = mitochondrial_thresh, linetype = "dashed") +
    labs(y = "% mitochondrial genes") +
    
    scater::plotColData(sce, y = "libComplexity", color_by = color_groups) +
    labs(y = "log10(nGenes) / log10(nUMIs)") +
    
    scater::plotColData(sce, y = "subsets_Ribo_percent", color_by = color_groups) + scale_y_continuous(limits = c(0, 100)) +
    labs(y = "% ribosomal genes") +
    
    scater::plotColData(sce, y = "Mito_Ribo_Ratio", color_by = color_groups) +
    labs(y = "%Mito / (%Mito + %Ribo)") +
    
    scater::plotColData(sce,
                        x = "sum",
                        y = "detected",
                        color_by = color_groups) +
    scale_x_continuous(trans = "log10") +
    scale_y_continuous(trans = "log10") +
    geom_vline(xintercept = nUMI_thresh, linetype = "dashed") +
    geom_hline(yintercept = nGenes_thresh, linetype = "dashed") +
    labs(x = "UMIs per cell, log10", y = "Genes per cell, log10") +
    
    scater::plotColData(sce,
                        x = "detected",
                        y = "libComplexity",
                        color_by = color_groups) +
    scale_x_continuous(trans = "log10") +
    geom_vline(xintercept = nGenes_thresh, linetype = "dashed") +
    labs(x = "Genes per cell, log10", y = "log10(nGenes) / log10(nUMIs)") +
    
    scater::plotColData(sce,
                        x = "detected",
                        y = "Mito_Ribo_Ratio",
                        color_by = color_groups) +
    scale_x_continuous(trans = "log10") +
    geom_vline(xintercept = nGenes_thresh, linetype = "dashed") +
    labs(x = "Genes per cell, log10", y = "%Mito / (%Mito + %Ribo)")
}
```

# Read the sce

```{r load_sce}
sce <- readRDS(path_sce_input)
sce
```

# Remove doublets detected in the previous step

```{r remove_doublets}
sce <- sce[, sce$scDblFinder.class == "singlet"]
sce
```

# Add QC metrics

```{r add_QC_metrics}
QC.genes <- list(
    Mito = stringr::str_which(rowData(sce)[["Symbol"]], "^MT-"),
    Ribo = stringr::str_which(rowData(sce)[["Symbol"]], "^RPL")
    )

sce <- addPerCellQCMetrics(sce, subsets = QC.genes)

sce$libComplexity <- log10(sce$detected) / log10(sce$sum)
sce$Mito_Ribo_Ratio <- sce$subsets_Mito_percent / (sce$subsets_Mito_percent + sce$subsets_Ribo_percent)

sce$discard <- sce$sum < nUMI_thresh |
  sce$detected < nGenes_thresh |
  sce$subsets_Mito_percent > mitochondrial_thresh

sce
```

```{r, fig.width=11.2, fig.height=7}
metrics_QC_discard <- QC_plots(sce,
                               "discard",
                               nUMI_thresh,
                               nGenes_thresh,
                               mitochondrial_thresh)
metrics_QC_discard
```

# Seurat clustering

```{r}
rownames(sce) <- rowData(sce)[["Symbol"]]

seurat <- as.Seurat(sce, counts = "counts", data = NULL)

seurat <- NormalizeData(seurat,
                        normalization.method = "LogNormalize",
                        scale.factor = 10000)
seurat <- FindVariableFeatures(
  seurat,
  selection.method = "vst",
  loess.span = 0.3,
  nfeatures = 2000
)
seurat <- ScaleData(seurat, model.use = "linear")
seurat <- RunPCA(seurat)
seurat <- RunUMAP(seurat, reduction = "pca", dims = 1:20)
seurat <- FindNeighbors(
  seurat,
  k.param = c(30),
  reduction = "pca",
  dims = 1:20
)
seurat <- FindClusters(seurat,
                       resolution = 0.5)
```

```{r, fig.width=9, fig.height=4}
sce <- as.SingleCellExperiment(seurat)

plotUMAP(sce,
         color_by = "originalexp_snn_res.0.5",
         text_by = "originalexp_snn_res.0.5") +
  plotUMAP(sce,
         color_by = "discard")
```



# Write resulting sce

```{r}
sce
```


```{r write_sce}
saveRDS(sce, path_sce_output)
```

# Session info

```{r sessionInfo}
print(sessionInfo())
```

```{r gc}
gc()
```
